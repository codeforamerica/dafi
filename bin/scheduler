#!/usr/bin/env ruby

require 'rufus-scheduler'
require File.expand_path(File.join(File.dirname(__FILE__), '..', 'config', 'environment'))

scheduler = Rufus::Scheduler.new

scheduler.every ENV.fetch('SEARCH_REFRESH_INTERVAL', '1m'), overlap: false do
  puts '=== refreshing materialized views ==='
  AidApplicationSearch.refresh
end

# every day at 2am UTC
scheduler.cron '0 2 * * *' do
  puts '=== deleting unsubmitted aid applications that are at least 24 hours old ==='
  cleaner = AidApplicationCleaner.new
  cleaner.delete_stale_and_unsubmitted
end

scheduler.join
