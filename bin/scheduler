#!/usr/bin/env ruby

require 'rufus-scheduler'
require File.expand_path(File.join(File.dirname(__FILE__), '..', 'config', 'environment'))

scheduler = Rufus::Scheduler.new

scheduler.every ENV.fetch('SEARCH_REFRESH_INTERVAL', '1m'), overlap: false do
  puts '=== refreshing materialized views ==='
  AidApplicationSearch.refresh
end

# every day at 8AM UTC / Midnight-ish Pacific
scheduler.cron '0 8 * * *' do
  puts '=== deleting unsubmitted aid applications that are at least 24 hours old ==='
  AidApplication.delete_stale_and_unsubmitted
end

# TODO: Uncomment on Friday, June 5, 2020
# # every day at 8AM UTC / Midnight-ish Pacific
scheduler.cron '0 8 * * *' do
  puts '=== pausing unapproved aid applications that are at least AidApplication::PAUSE_INTERVAL old ==='
  AidApplication.pause_stale_and_unapproved
end

scheduler.join
